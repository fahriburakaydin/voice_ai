## ğŸ“œ Overview

**Sophie Voice Bot** is an interactive, voice-enabled chatbot built with FastAPI and deployed on Google Cloud Run. It lets users send text or recorded voice messages and receive spoken replies generated by OpenAIâ€™s Chat API and ElevenLabs TTS. The system maintains both short-term and long-term â€œmemoriesâ€ so Sophie can recall context and learn over time.

---

## ğŸ” Key Features

- **Dual Input**: Users can type or speak; speech is transcribed via Whisper STT.
- **Conversational AI**: Prompts are sent to OpenAI Chat API (GPT-4) with system instructions and memory context.
- **Text-to-Speech**: Replies are converted to MP3 via ElevenLabs, then streamed back.
- **Memory**:
    - *Short-term* (Redis): last few turns for immediate context
    - *Long-term* (Pinecone): extracted â€œinsightsâ€ stored as vectors for recall
- **Serverless Deployment**: All services run on Cloud Run behind a CDN; secrets and credentials managed via Secret Manager.

---

## âš™ï¸ Architecture


![image.png](attachment:ecddbdeb-ce8c-43c0-a016-dbf634dc6490:image.png)

- **Browser UI** (top-left) â€“ The single-page app in your usersâ€™ browsers, built with vanilla JS, HTML, and CSS.
- **FastAPI API server** (center) â€“ Hosted on **Google Cloud Run**, this is the core service that orchestrates everything.
    - Receives text or audio uploads from the UI
    - Routes audio to **Whisper STT** (speech-to-text)
    - Sends combined prompt+memory to **OpenAI ChatGPT** for responses
    - Streams ChatGPT reply to **ElevenLabs TTS** (text-to-speech)
    - Stores generated audio blobs in **Google Cloud Storage**
    - Manages short-term chat history in **Redis Memorystore**
    - Manages long-term insights in **Pinecone** vector DB
- **External APIs** (right):
    - **Whisper STT**: Transcribes user voice to text
    - **OpenAI ChatGPT**: Generates conversational replies
    - **ElevenLabs TTS**: Synthesizes voice responses
- **State & Storage** (bottom):
    - **Google Cloud Storage**: Hosts signed URLs for audio playback
    - **Redis Memorystore**: Quick, ephemeral chat history per user
    - **Pinecone Vector Database**: Persistent â€œinsightsâ€ and semantic memory

---

## ğŸ§© Code Structure

```
pgsql
CopyEdit
sophie-voice-bot/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py           # FastAPI endpoints & CORS/static mounting
â”‚   â”œâ”€â”€ config.py         # Pydantic Settings (env, secrets)
â”‚   â”œâ”€â”€ stt.py            # Whisper transcription
â”‚   â”œâ”€â”€ gpt.py            # Chat completion & prompt templates
â”‚   â”œâ”€â”€ tts.py            # ElevenLabs TTS wrapper
â”‚   â”œâ”€â”€ storage.py        # GCS upload + signed URLs
â”‚   â”œâ”€â”€ memory.py         # Redis & Pinecone helpers
â”‚   â””â”€â”€ static/           # index.html + main.js + CSS
â”œâ”€â”€ Dockerfile
â””â”€â”€ requirements.txt

```

---

## â˜ï¸ GCP Project

- **Cloud Run**: Hosts the FastAPI container (auto-scale, vCPU boost)
- **Secret Manager**: Stores API keys (`OPENAI_API_KEY`, `ELEVEN_API_KEY`, Pinecone, and SA JSON)
- **Cloud Storage**: Bucket `voice-ai-458213-sophie-bucket` for MP3 assets, public via Uniform access
- **Redis**: Memorystore instance for short-term chat history
- **Pinecone**: Vector index `sophie-memory` for long-term insights
- **VPC Connector**: Secure egress to Redis
- **IAM**: Service account `voice-ai-bot@â€¦` has roles for Storage Admin, Secret Accessor, Redis Editor, Token Creator

---

## ğŸš€ Deployment Steps

1. **Build & Push** Docker image
    
    ```powershell
    powershell
    CopyEdit
    docker build -t gcr.io/voice-ai-458213/sophie-bot:latest .
    docker push gcr.io/voice-ai-458213/sophie-bot:latest
    
    ```
    
2. **Configure Secrets**
    
    ```
    shell
    CopyEdit
    gcloud secrets create openai-api-key --data-file=<(echo $OPENAI_API_KEY)
    # â€¦ repeat for eleven-api-key, pinecone-api-key, sa-key-json
    
    ```
    
3. **Deploy to Cloud Run**
    
    ```powershell
    powershell
    CopyEdit
    gcloud run deploy sophie-bot `
      --image gcr.io/voice-ai-458213/sophie-bot:latest `
      --platform=managed --region=europe-north1 `
      --allow-unauthenticated `
      --service-account=voice-ai-bot@voice-ai-458213.iam.gserviceaccount.com `
      --update-secrets "OPENAI_API_KEY=openai-api-key:latest,..." `
      --set-env-vars "GCP_PROJECT=voice-ai-458213,GCS_BUCKET=voice-ai-458213-sophie-bucket,REDIS_URL=redis://[HOST]:6379/0,PINECONE_ENV=us-east1-aws,PINECONE_INDEX=sophie-memory"
    
    ```
    

---

## ğŸ“Š Visual Summary

| Component | Technology | Role |
| --- | --- | --- |
| **API** | FastAPI / Uvicorn | HTTP + CORS + Static UI |
| **STT** | OpenAI Whisper | Audio â†’ Text |
| **Chat** | OpenAI Chat API (GPT) | Generates conversational replies |
| **TTS** | ElevenLabs | Text â†’ MP3 |
| **Storage** | GCS | Serve audio URLs |
| **Short-term** | Redis Memorystore | Immediate chat history |
| **Long-term** | Pinecone | Vector search over user â€œinsightsâ€ |

---

> â€œSophie Voice Botâ€ showcases full-stack voice AI: from browser recording to serverless APIs, cloud storage, and semantic memory. Itâ€™s production-ready, scalable, and easily extensible for new voices, languages, or memory features.
>